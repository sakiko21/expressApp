<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会員マイページ</title>
    <Link rel="stylesheet" href ="../style.css">
</head>
<body>
    <h2 class="page-title">マイページ</h2>
    <table id="purchase-history">
        <thead>
            <tr>
                <th>購入日時</th>
                <th>商品名</th>
                <th>購入個数</th>
                <th>金額</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div class="button-area">
        <a class="top-button" href="/products/catalog.html">商品一覧へ</a>
    </div>
</body>
<script>
    // ページのロード時に実行する処理
window.onload = function() {
    // トークンをクッキーから取得する
    const token = document.cookie.replace(/(?:(?:^|.*;\s*)token\s*\=\s*([^;]*).*$)|^.*$/, "$1");

    // トークンを使ってアカウントページへのリクエストを行う
    fetch('/user/account', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    // .then((res) => res.json())
    .then (async (response) => {
        if (response.ok){
        const data = await response.json();
        const purchaseHistory = data.purchaseHistory;
        console.log("purchaseHistory:",purchaseHistory);

        const tableBody = document.querySelector('#purchase-history tbody');
        purchaseHistory.forEach((purchase) => {
            const { created_at, product_names, quantity, amount } = purchase;

            const row = document.createElement('tr');
            const dateCell = document.createElement('td');
            const productNameCell = document.createElement('td');
            const quantityCell = document.createElement('td');
            const totalPriceCell = document.createElement('td');

            dateCell.textContent = created_at;
            productNameCell.textContent = product_names;
            quantityCell.textContent = quantity;
            totalPriceCell.textContent = amount;

            row.appendChild(dateCell);
            row.appendChild(productNameCell);
            row.appendChild(quantityCell);                
            row.appendChild(totalPriceCell);
            tableBody.appendChild(row);
            });
        } else {
            console.log("エラーレスポンス", response.status);
        }   
    })
    .catch((error) => {
        // エラーハンドリング
        console.log("エラー", error);
    });
};

//ページが読み込まれたときに実行
// window.onload = function() {
//     fetch('/user/account')
//     .then((res) => {
//         if(res.status === 401){
//             // ユーザーがログインしていない場合、トップページにリダイレクト
//             window.location.href = '/';
//         } else {
//             // ユーザーがログインしている場合、その他の処理を行う（必要に応じて）
//         }
//     })
//     .catch((err) => {
//         console.error(err);
//     });
// };

</script>

<!-- <script>
// ページのロード時に実行する処理
window.onload = function() {
    // トークンをクッキーから取得する
    console.log("document.cookie", document.cookie);
    const token = document.cookie.replace(/(?:(?:^|.*;\s*)user_token\s*\=\s*([^;]*).*$)|^.*$/, "$1");
    console.log(document.cookie);
    if (!token || token === ""){
        //トークンがない場合、ログインページへリダイレクト.マイページの検証のため一旦コメントアウト
        console.log("Token value:", token);
        console.log("document.cookie:",document.cookie);
        console.log("req.cookies.user_token", req.cookies.user_token);

        console.log(token);
        console.log("トークンがない");
        return window.location.href = "/user/login";
    }
        // トークンを使ってアカウントページへのリクエストを行う
        console.log(token);
        console.log("アカウントページへのリクエスト送信が行われてそうかチェック");
    //     fetch("/user/account", {
    //         method: "GET",
    //         headers: {
    //             "Authorization": `Bearer ${token}`,
    //         }
    //     })
    //     // レスポンスのbodyをテキストとして読み込む（今だけ）
    //     .then((res) => res.text())
    //     .then((data) => {
    //         console.log("Server response:", data);
    //         const user = data;
    //         console.log(user.id);
    //         if (user.id){
    //             console.log("ユーザーIDが存在する");
    //             const accountUrl = `/user/account/${user.id}`;
    //             console.log("accountUrl:", accountUrl);
    //             window.location.href = accountUrl;
    //         }else{
    //             // ユーザーが存在しない場合、ログインページへリダイレクト
    //             console.log("ユーザーが存在しない");
    //             window.location.href = "/user/login";
    //         }
    //     })
    //     .catch((err) => {
    //         console.log("エラーが発生しました：",err);
    //     });
        
    // };
};
</script> -->
</html>